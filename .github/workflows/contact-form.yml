name: Contact Form Handler

on:
  issues:
    types: [opened]

jobs:
  process_contact:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'contact-form')
    
    steps:
    - name: Parse Contact Form
      id: parse
      uses: actions/github-script@v7
      with:
        script: |
          const issue = context.payload.issue;
          const body = issue.body;
          
          // Basic spam detection
          const spamKeywords = ['crypto', 'bitcoin', 'loan', 'casino', 'viagra', 'pharmacy'];
          const isSpam = spamKeywords.some(keyword => 
            body.toLowerCase().includes(keyword.toLowerCase())
          );
          
          // Check for multiple URLs
          const urlMatches = body.match(/http[s]?:\/\/[^\s]+/g);
          const hasMultipleUrls = urlMatches && urlMatches.length > 1;
          
          if (isSpam || hasMultipleUrls) {
            console.log('Spam detected, skipping email');
            core.setOutput('isSpam', 'true');
            return;
          }
          
          // Extract form data (assumes structured format)
          const lines = body.split('\n');
          let formData = {
            name: 'Unknown',
            email: 'unknown@example.com', 
            company: 'Not specified',
            message: body
          };
          
          for (let line of lines) {
            if (line.includes('**Name:**')) {
              const name = line.split('**Name:**')[1]?.trim();
              if (name) formData.name = name;
            }
            if (line.includes('**Email:**')) {
              const email = line.split('**Email:**')[1]?.trim();
              if (email) formData.email = email;
            }
            if (line.includes('**Company:**')) {
              const company = line.split('**Company:**')[1]?.trim();
              if (company) formData.company = company;
            }
            if (line.includes('**Message:**')) {
              const messageStart = body.indexOf('**Message:**') + 12;
              const message = body.substring(messageStart).trim();
              if (message) formData.message = message;
            }
          }
          
          // Set outputs
          core.setOutput('isSpam', 'false');
          core.setOutput('name', formData.name);
          core.setOutput('email', formData.email);
          core.setOutput('company', formData.company);
          core.setOutput('message', formData.message);

    - name: Send Email Notification
      if: steps.parse.outputs.isSpam != 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.office365.com
        server_port: 587
        secure: true
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "New Contact Form Submission - Anaxiatech"
        to: theresia.lundgren@anaxiatech.se
        from: ${{ secrets.SMTP_USERNAME }}
        html_body: |
          <h2>New Contact Form Submission</h2>
          <p><strong>Name:</strong> ${{ steps.parse.outputs.name }}</p>
          <p><strong>Email:</strong> ${{ steps.parse.outputs.email }}</p>
          <p><strong>Company:</strong> ${{ steps.parse.outputs.company }}</p>
          <p><strong>Message:</strong></p>
          <div style="padding: 10px; background: #f5f5f5; border-radius: 5px; white-space: pre-wrap;">
            ${{ steps.parse.outputs.message }}
          </div>
          <hr>
          <p><em>Submitted via anaxiatech.se contact form</em></p>

    - name: Close and Label Issue
      if: steps.parse.outputs.isSpam != 'true'
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.update({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            state: 'closed',
            labels: ['contact-form', 'processed']
          });
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: 'âœ… Contact form processed and email sent successfully.'
          });

    - name: Handle Spam
      if: steps.parse.outputs.isSpam == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.update({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            state: 'closed',
            labels: ['contact-form', 'spam']
          });
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: 'ðŸš« Message flagged as spam and blocked.'
          });