name: Contact Form Handler

on:
  issues:
    types: [opened]

jobs:
  process_contact:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'contact-form')
    
    steps:
    - name: Parse Contact Form
      id: parse
      uses: actions/github-script@v7
      with:
        script: |
          const issue = context.payload.issue;
          const body = issue.body;
          
          // Basic spam detection
          const spamKeywords = ['crypto', 'bitcoin', 'loan', 'casino', 'viagra', 'pharmacy'];
          const isSpam = spamKeywords.some(keyword => 
            body.toLowerCase().includes(keyword.toLowerCase())
          );
          
          if (isSpam) {
            console.log('Spam detected, skipping email');
            return { isSpam: true };
          }
          
          // Extract form data (assumes structured format)
          const lines = body.split('\n');
          let formData = {};
          
          for (let line of lines) {
            if (line.includes('**Name:**')) {
              formData.name = line.split('**Name:**')[1]?.trim();
            }
            if (line.includes('**Email:**')) {
              formData.email = line.split('**Email:**')[1]?.trim();
            }
            if (line.includes('**Company:**')) {
              formData.company = line.split('**Company:**')[1]?.trim();
            }
            if (line.includes('**Message:**')) {
              const messageStart = body.indexOf('**Message:**') + 12;
              formData.message = body.substring(messageStart).trim();
            }
          }
          
          return { isSpam: false, formData };

    - name: Send Email Notification
      if: steps.parse.outputs.isSpam != 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.office365.com
        server_port: 587
        secure: true
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "New Contact Form Submission - Anaxiatech"
        to: theresia.lundgren@anaxiatech.se
        from: ${{ secrets.SMTP_USERNAME }}
        html_body: |
          <h2>New Contact Form Submission</h2>
          <p><strong>Name:</strong> ${{ fromJson(steps.parse.outputs.result).formData.name }}</p>
          <p><strong>Email:</strong> ${{ fromJson(steps.parse.outputs.result).formData.email }}</p>
          <p><strong>Company:</strong> ${{ fromJson(steps.parse.outputs.result).formData.company }}</p>
          <p><strong>Message:</strong></p>
          <div style="padding: 10px; background: #f5f5f5; border-radius: 5px;">
            ${{ fromJson(steps.parse.outputs.result).formData.message }}
          </div>
          <hr>
          <p><em>Submitted via anaxiatech.se contact form</em></p>

    - name: Close and Label Issue
      if: steps.parse.outputs.isSpam != 'true'
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.update({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            state: 'closed',
            labels: ['contact-form', 'processed']
          });
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: 'âœ… Contact form processed and email sent successfully.'
          });

    - name: Handle Spam
      if: steps.parse.outputs.isSpam == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.update({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            state: 'closed',
            labels: ['contact-form', 'spam']
          });
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: 'ðŸš« Message flagged as spam and blocked.'
          });